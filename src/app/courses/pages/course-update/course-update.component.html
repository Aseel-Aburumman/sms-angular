<div class="course-page">
  <div class="container-fluid py-3 py-md-4">

    <!-- Header -->
    <div class="d-flex align-items-center justify-content-between mb-3">
      <div>
        <div class="tiny text-uppercase text-muted">Course manage</div>
        <div class="fw-semibold text-dark">Edit course and manage students</div>
      </div>
      <a routerLink="/courses" class="btn btn-light border rounded-pill btn-sm px-3">‚Üê Back</a>
    </div>

    <div *ngIf="isLoading" class="cardx p-4">
      <div class="skeleton-line w-25 mb-3"></div>
      <div class="skeleton-line w-75 mb-2"></div>
      <div class="skeleton-line w-50"></div>
    </div>

    <div *ngIf="serverError" class="alert alert-danger rounded-4 shadow-sm">{{ serverError }}</div>

    <ng-container *ngIf="!isLoading && course as c">

       <div class="cardx p-3 p-md-4 mb-4">
        <div class="row g-3 g-md-4 align-items-stretch">

          <div class="col-12 col-lg-4">
            <div class="rounded-4 bg-light p-3 position-relative d-flex align-items-center justify-content-center"
              style="min-height: 260px;">

              <label class="btn btn-sm btn-light border position-absolute"
                style="top: 12px; left: 12px; width: 36px; height: 36px; display:flex; align-items:center; justify-content:center; border-radius:10px; cursor:pointer;"
                title="Change photo">
                <i class="fa-solid fa-camera"></i>
                <input type="file" accept="image/*" hidden (change)="onPickImage($event)" />
              </label>

               <ng-container *ngIf="course?.imageUrl; else avatarPlaceholder">
                 <img [src]="getProfileImageUrl() || 'assets/user.png'" alt="Profile"
                  style="width: 297px; height: 290px; object-fit: cover; border-radius: 18px;" />

              </ng-container>

               <ng-template #avatarPlaceholder>
                <div class="d-flex align-items-center justify-content-center"
                  style="width: 180px; height: 180px; border-radius: 18px; background: #e9ecef;">
                  <i class="fa-solid fa-user" style="font-size: 70px; opacity: .35;"></i>
                </div>
              </ng-template>
            </div>
          </div>

          <div class="col-12 col-lg-8 d-flex flex-column">
            <div class="d-flex align-items-center justify-content-between mb-2">
              <div class="tiny text-muted text-uppercase">Manage course</div>
              <span class="pill pill-soft">{{ c.credits }} credits</span>
            </div>

            <h2 class="h4 fw-bold mb-2 text-dark">{{ c.name }}</h2>

            <p class="text-muted mb-3 course-desc">
              {{ c.description || 'No description provided.' }}
            </p>

            <div class="d-flex flex-wrap gap-2 mb-3">
              <span class="pill">üë• {{ c.enrollments?.length || 0 }} enrolled</span>
              <span class="pill">üìÖ {{ c.createdAt | date:'mediumDate' }}</span>
            </div>

            <div class="mt-auto d-flex flex-wrap gap-2">
              <button class="btn   px-4" [class.border]="!viewMode" [class.btn-light]="!viewMode"
                [class.btn-primary-neo]=" viewMode" (click)="viewMode = true">
                Manage Students
              </button>
              <button class="btn    rounded-3 px-4" [class.border]=" viewMode" [class.btn-light]=" viewMode"
                [class.btn-primary-neo]="!viewMode" (click)="viewMode = false">
                Edit Course
              </button>
            </div>
          </div>

        </div>
      </div>

       <div class="row g-4">

         <div class="col-12 col-lg-8" *ngIf="viewMode">

           <div class="cardx p-3 p-md-4 mb-4">
            <div class="d-flex flex-wrap gap-2">
              <button class="chip" [class.active]="manageMode" (click)="manageMode = true">
                Enrolled Students
              </button>
              <button class="chip" [class.active]="!manageMode" (click)="newEnrollmentMode()">
                Add Students
              </button>
            </div>
          </div>

           <div class="cardx p-3 p-md-4" *ngIf="manageMode">
            <div class="d-flex align-items-center justify-content-between mb-3">
              <div class="fw-semibold text-uppercase text-muted tiny">Enrollments</div>
              <span class="pill pill-soft">{{ c.enrollments?.length || 0 }} total</span>
            </div>

            <div *ngIf="!c.enrollments?.length" class="empty-box">
              <div class="fw-semibold mb-1">No enrollments yet</div>
              <div class="text-muted small">Enroll students from the ‚ÄúAdd Students‚Äù tab.</div>
            </div>

            <div class="enroll-list" *ngIf="c.enrollments?.length">
              <div class="enroll-row" *ngFor="let e of c.enrollments; trackBy: trackById">
                <div class="d-flex align-items-center gap-3">
                  <div class="avatar-sm">{{ (e.studentName?.[0] || '?') | uppercase }}</div>
                  <div class="min-w-0">
                    <div class="fw-semibold text-dark text-truncate">{{ e.studentName }}</div>
                    <div class="text-muted small">
                      Enrolled: {{ e.enrollmentDate | date:'mediumDate' }}
                    </div>
                  </div>
                </div>

                <div class="d-flex align-items-center gap-2">

                   <select class="form-select form-select-sm grade-select" [(ngModel)]="e.grade"
                    (ngModelChange)="updateEnrollmentGrade(e.id, $event)"
                    [disabled]="isGradeUpdatingId === e.id || isUnrolling">
                    <option [ngValue]="null">N/A</option>
                    <option *ngFor="let g of grades" [ngValue]="g">{{ g }}</option>
                  </select>


                  <button class="btn btn-outline-danger btn-sm rounded-3" (click)="unRoll(e.id)"
                    [disabled]="isUnrolling">
                    Unroll
                  </button>
                </div>
              </div>
            </div>

            <div *ngIf="enrollError" class="alert alert-danger mt-3 rounded-4">{{ enrollError }}</div>
          </div>

           <div class="cardx p-3 p-md-4" *ngIf="!manageMode">
            <div class="d-flex align-items-center justify-content-between mb-3">
              <div class="fw-semibold text-uppercase text-muted tiny">All students</div>
              <span class="pill pill-soft">Pick one to enroll</span>
            </div>

             <div class="row g-2 align-items-center mb-3">
              <div class="col-12 col-md-8">
                <input class="form-control" [(ngModel)]="search" name="studentName"
                  (ngModelChange)="onSearchChange($event)" placeholder="Search by name or email..." />
              </div>


            </div>

            <div *ngIf="isStudentLoading" class="alert alert-info rounded-4">Loading students...</div>

            <div *ngIf="!isStudentLoading && students.length === 0" class="empty-box">
              <div class="fw-semibold mb-1">No students found</div>
              <div class="text-muted small">Try a different search term.</div>
            </div>

            <div class="student-grid" *ngIf="!isStudentLoading && students.length">
              <button type="button" class="student-card" *ngFor="let s of students; trackBy: trackById"
                (click)="selectStudent(s.id)" [class.selected]="selectedStudentId === s.id"
                [disabled]="!isStudentAvailable(s.id)">

                <div class="d-flex align-items-center gap-3">
                  <div class="avatar-sm">{{ (s.fullName?.[0] || '?') | uppercase }}</div>
                  <div class="min-w-0 text-start">
                    <div class="fw-semibold text-dark text-truncate">{{ s.fullName }}</div>
                    <div class="text-muted small text-truncate">{{ s.email }}</div>
                  </div>
                </div>

                <div class="tiny text-muted mt-2 text-start">
                  <span *ngIf="isStudentAvailable(s.id); else alreadyEnrolled">
                    Available
                  </span>
                  <ng-template #alreadyEnrolled>
                    <span class="text-danger">Already enrolled</span>
                  </ng-template>
                </div>
              </button>
            </div>
            <div class="d-flex justify-content-center mt-4" *ngIf="totalCount > 0">
              <mat-paginator [length]="totalCount" [pageSize]="pageSize" [pageIndex]="page - 1"
                [pageSizeOptions]="[6, 9, 12, 18]" (page)="onPageChange($event)">
              </mat-paginator>
            </div>
            <div class="mt-3 d-flex gap-2">
              <button class="btn btn-primary-neo px-4" [disabled]="!selectedStudentId || isEnrolling || !course?.id"
                (click)="enroll(selectedStudentId!, selectedGrade)">
                Enroll Selected
              </button>

              <button class="btn btn-light border rounded-3 px-4" (click)="manageMode = true">
                Cancel
              </button>
            </div>

            <div *ngIf="enrollError" class="alert alert-danger mt-3 rounded-4">{{ enrollError }}</div>
          </div>

        </div>

         <div *ngIf=" viewMode" class="col-12 col-lg-4">

           <div class="cardx p-3 p-md-4 mb-4" *ngIf="currentRole.includes('Admin')">
            <div class="fw-semibold text-uppercase text-muted tiny mb-3">Assign teacher</div>

            <button class="btn btn-light border w-100 rounded-3 mb-2" type="button" (click)="loadTeachers()"
              [disabled]="isTeachersLoading">
              Load Teachers
            </button>

            <div *ngIf="teacherError" class="alert alert-danger rounded-4">{{ teacherError }}</div>

            <div *ngIf="isTeachersLoading" class="alert alert-info rounded-4">Loading teachers...</div>

            <div *ngIf="!isTeachersLoading && teachers.length" class="teacher-list">
              <button type="button" class="teacher-row" *ngFor="let t of teachers" (click)="assignTeacher(t.id)"
                [disabled]="isUpdating">
                <div class="min-w-0 text-start">
                  <div class="fw-semibold text-dark text-truncate">{{ t.fullName }}</div>
                  <div class="text-muted small text-truncate">{{ t.email }}</div>
                </div>
                <span class="pill pill-soft">Assign</span>
              </button>
            </div>

            <div class="mt-3">
              <div class="tiny text-muted">Current TeacherId</div>
              <div class="pill mt-1">{{ c.teacherId || 'N/A' }}</div>
              <div class="d-flex w-100 gap-1">
                <div class="d-flex w-50 flex-column">
                  <div class="tiny text-muted mt-1">Teacher Name</div>
                  <div class="pill mt-1">{{ c.teacher?.fullName || 'N/A' }}</div>
                </div>
                <div class="d-flex w-50 flex-column">

                  <div class="tiny text-muted mt-1">Teacher phone</div>
                  <div class="pill mt-1">{{ c.teacher?.phoneNumber || 'N/A' }}</div>
                </div>

              </div>
              <div class="tiny text-muted mt-1">Teacher Email</div>
              <div class="pill mt-1">{{ c.teacher?.email || 'N/A' }}</div>
            </div>
          </div>

           <div class="cardx p-3 p-md-4">
            <div class="fw-semibold text-uppercase text-muted tiny mb-3">Course status</div>

            <div class="d-flex flex-column gap-2">
              <div class="pill">CourseId: {{ c.id }}</div>
              <div class="pill">Credits: {{ c.credits }}</div>
              <div class="pill">Enrollments: {{ c.enrollments?.length || 0 }}</div>
            </div>
          </div>

        </div>

      </div>

       <div *ngIf="!viewMode" class="p-3 p-md-4 row g-4">


        <div *ngIf="!viewMode" class="col-12 col-lg-8">
          <form [formGroup]="form" (ngSubmit)="submit()" class="cardx p-3 p-md-4">
            <div class="d-flex align-items-center justify-content-between mb-3">
              <div class="fw-semibold text-uppercase text-muted tiny">Edit course</div>
              <button class="btn btn-light border rounded-3" type="button" (click)="viewMode = true">
                Back to manage
              </button>
            </div>

            <div class="mb-3">
              <label class="form-label">Name</label>
              <input class="form-control" formControlName="name" />
              <div class="text-danger small mt-1" *ngIf="form.controls.name.touched && form.controls.name.invalid">
                <span *ngIf="form.controls.name.errors?.['required']">Name is required.</span>
                <span *ngIf="form.controls.name.errors?.['minlength']">Min 2 characters.</span>
              </div>
            </div>

            <div class="mb-3">
              <label class="form-label">Description</label>
              <textarea class="form-control" rows="4" formControlName="description"></textarea>
              <div class="text-danger small mt-1"
                *ngIf="form.controls.description.touched && form.controls.description.invalid">
                <span *ngIf="form.controls.description.errors?.['maxlength']">Max 500 characters.</span>
              </div>
            </div>

            <div class="mb-3">
              <label class="form-label">Credits</label>
              <input type="number" class="form-control" formControlName="credits" />
              <div class="text-danger small mt-1"
                *ngIf="form.controls.credits.touched && form.controls.credits.invalid">
                <span *ngIf="form.controls.credits.errors?.['required']">Credits is required.</span>
              </div>
            </div>

            <div class="d-flex gap-2">
              <button class="btn btn-primary-neo px-4" type="submit" [disabled]="isUpdating">
                Save changes
              </button>
              <button class="btn btn-light border rounded-3 px-4" type="button" (click)="viewMode = true"
                [disabled]="isUpdating">
                Cancel
              </button>
            </div>

            <div *ngIf="serverError" class="alert alert-danger rounded-4 mt-3">{{ serverError }}</div>
          </form>
        </div>


        <div class="col-12 col-lg-4 cardx p-3 p-md-4 mb-4" *ngIf="currentRole.includes('Admin')">
          <div class="fw-semibold text-uppercase text-muted tiny mb-3">Assign teacher</div>

          <button class="btn btn-light border w-100 rounded-3 mb-2" type="button" (click)="loadTeachers()"
            [disabled]="isTeachersLoading">
            Load Teachers
          </button>

          <div *ngIf="teacherError" class="alert alert-danger rounded-4">{{ teacherError }}</div>

          <div *ngIf="isTeachersLoading" class="alert alert-info rounded-4">Loading teachers...</div>

          <div *ngIf="!isTeachersLoading && teachers.length" class="teacher-list">
            <button type="button" class="teacher-row" *ngFor="let t of teachers" (click)="assignTeacher(t.id)"
              [disabled]="isUpdating">
              <div class="min-w-0 text-start">
                <div class="fw-semibold text-dark text-truncate">{{ t.fullName }}</div>
                <div class="text-muted small text-truncate">{{ t.email }}</div>
              </div>
              <span class="pill pill-soft">Assign</span>
            </button>
          </div>

          <div class="mt-3">
            <div class="tiny text-muted">Current TeacherId</div>
            <div class="pill mt-1">{{ c.teacherId || 'N/A' }}</div>
            <div class="d-flex w-100 gap-1">
              <div class="d-flex w-50 flex-column">
                <div class="tiny text-muted mt-1">Teacher Name</div>
                <div class="pill mt-1">{{ c.teacher?.fullName || 'N/A' }}</div>
              </div>
              <div class="d-flex w-50 flex-column">

                <div class="tiny text-muted mt-1">Teacher phone</div>
                <div class="pill mt-1">{{ c.teacher?.phoneNumber || 'N/A' }}</div>
              </div>

            </div>
            <div class="tiny text-muted mt-1">Teacher Email</div>
            <div class="pill mt-1">{{ c.teacher?.email || 'N/A' }}</div>
          </div>
        </div>
      </div>

    </ng-container>

  </div>
</div>