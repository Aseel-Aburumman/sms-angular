<!-- Header -->
<div class="  flex-md-row justify-content-between align-items-start align-items-md-center mb-4 gap-2">
  <div>
    <h2 class="fw-semibold m-0">Courses</h2>
    <div class="text-muted small">Browse and manage courses based on your role.</div>
  </div>
  <div class="row g-2 my-2">
    <div class="d-flex align-items-center justify-content-between g-2 mb-3">
      <div class="col-12 col-md-6 col-lg-5">


        <div class="input-group">
          <span class="input-group-text bg-white">
            <i class="fa-solid fa-magnifying-glass"></i>
          </span>

          <input class="form-control" placeholder="Search by name or email..." [ngModel]="search"
            (ngModelChange)="onSearchChange($event)" />

          <button *ngIf="search" class="btn btn-outline-secondary" type="button" (click)="onSearchChange('')">
            <i class="fa-solid fa-xmark"></i>
          </button>
        </div>
      </div>

      <!-- Actions row (put this next to search / add button like your layout) -->
      <div class="d-flex flex-wrap align-items-center justify-content-between gap-2">
        <!-- left side can be your search -->
        <!-- ... -->

        <!-- right side actions -->
        <div class="d-flex flex-wrap align-items-center gap-2 ms-auto">
          <div class="upload-group px-3 py-0 d-flex align-items-center gap-2">
            <input #fileInput type="file" accept=".xlsx" class="d-none" (change)="onFileSelected($event)" />

            <div type="button" class="btn btn-light bg-white border-0  " (click)="fileInput.click()">
              Choose file |
            </div>

            <span class="file-pill" *ngIf="selectedFile" [class.file-pill--empty]="!selectedFile">
              {{ selectedFile?.name || 'No file chosen' }}
            </span>

            <div type="button" class="px-1 " (click)="upload()">
              <span *ngIf="!isUploading"><i class="fa-solid fa-upload"></i></span>
              <span *ngIf="isUploading">Uploading...</span>
            </div>
          </div>

          <button *ngIf="currentRole.includes('Admin') || currentRole.includes('Teacher')"
            class="btn btn-primary-neo btn-sm py-2 px-3" routerLink="/courses/create">
            <i class="fa-solid fa-folder-plus me-2"></i>
            Add Course
          </button>
        </div>
      </div>

      <!-- Import result -->
      <div *ngIf="importResult" class="mt-3">
        <div *ngIf="importResult.errors?.length" class="alert alert-danger py-2 mb-0">
          <div class="fw-semibold mb-1">Errors</div>
          <ul class="mb-0 ps-3">
            <li *ngFor="let e of importResult.errors">
              Row: {{ e.row }} - {{ e.message }}
            </li>
          </ul>
        </div>

        <div *ngIf="!importResult.errors?.length" class="alert alert-success py-2 mb-0">
          Imported successfully.
        </div>
      </div>



    </div>

    <!-- Loading / Errors -->
    <div *ngIf="isLoading" class="alert alert-info">Loading...</div>
    <div *ngIf="error" class="alert alert-danger">{{ error }}</div>
    <div *ngIf="deleteError" class="alert alert-danger">{{ deleteError }}</div>

    <!-- ============================= -->
    <!-- STUDENT VIEW (Cards like image) -->
    <!-- ============================= -->
    <div *ngIf="!isLoading && currentRole.includes('Student')">
      <div class="row g-4">
        <div class="col-12 col-sm-6 col-lg-4" *ngFor="let course of courses">
          <div class="card border-0 shadow-sm h-100 rounded-4 overflow-hidden course-card">
            <!-- image area -->
            <div
              class="course-thumb d-flex align-items-center justify-content-center text-center text-white fw-semibold"
              [ngStyle]="{
    'background-image': 'url(' + getCourseBackground(course.id) + ')'
  }">
              <span class="course-title-overlay">
                {{ course.name }}
              </span>
            </div>


            <div class="card-body p-3">
              <div class="fw-semibold text-dark mb-1 text-truncate">
                {{ course.name }}
              </div>

              <div class="text-muted small mb-3 course-desc">
                {{
                course.description.length > 90
                ? course.description.slice(0,90) + '...'
                : course.description
                }}
              </div>

              <div class="d-flex align-items-center justify-content-between">
                <div class="text-muted small">
                  <span class="me-2"><i class="fa-regular fa-star me-1"></i>{{ course.credits }} credits</span>
                  <span><i class="fa-solid fa-users me-1"></i>{{ course.enrollments?.length || 0 }}</span>
                </div>

                <!-- View only -->
                <a class="course-link text-decoration-none fw-semibold" [routerLink]="['/courses', course.id]">
                  View
                  <i class="fa-solid fa-arrow-down ms-2 small"></i>
                </a>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div *ngIf="courses.length === 0" class="alert alert-info text-center">No courses found.</div>
      <div class="d-flex justify-content-center mt-4" *ngIf="totalCount > 0">
        <mat-paginator [length]="totalCount" [pageSize]="pageSize" [pageIndex]="page - 1"
          [pageSizeOptions]="[6, 9, 12, 18]" (page)="onPageChange($event)">
        </mat-paginator>
      </div>
    </div>


    <!-- ============================= -->
    <!-- ADMIN/TEACHER VIEW (Table) -->
    <!-- ============================= -->
    <div *ngIf="!isLoading && (currentRole.includes('Admin') || currentRole.includes('Teacher'))"
      class="shadow-sm rounded-4 overflow-hidden">
      <div class="table-responsive">
        <table class="table table-hover align-middle mb-0">
          <thead class="border-bottom bg-white">
            <tr class="table-light text-muted small">
              <th class="text-center ps-4 col-2">Name</th>
              <th class="text-center col-4">Description</th>
              <th class="text-center col-1">Credits</th>
              <th class="text-center  col-1">No. Students</th>
              <th *ngIf="currentRole.includes('Admin')" class="text-center col-1">Status</th>
              <th class="text-center col-3 pe-4">Actions</th>
              <th *ngIf="currentRole.includes('Admin')" class="text-end pe-3">
                <div class="d-flex align-items-center justify-content-end gap-2">
                  <button class="btn btn-sm btn-outline-danger bulk-trash" type="button" (click)="openBulkInactivate()"
                    [disabled]="selectedCourseIds.size === 0 || isBulkUpdating">
                    <i class="fa-solid fa-trash-can"></i>
                  </button>

                  <mat-checkbox [checked]="allCoursesChecked" [indeterminate]="someCoursesChecked"
                    (change)="toggleAllCoursesCurrentPage($event.checked)">
                  </mat-checkbox>
                </div>
              </th>

            </tr>
          </thead>

          <tbody>

            <tr *ngFor="let course of courses" [class.row-selected]="isCourseSelected(course.id)">
              <td class="text-center col-2 ps-4 fw-medium">
                {{
                course.name.length > 20
                ? (course.name.slice(0,20)) + '...'
                : course.name
                }}
              </td>

              <td class="text-start col-4 text-muted">
                {{
                course.description.length > 90
                ? course.description.slice(0,90) + '...'
                : course.description
                }}
              </td>

              <td class="text-center">{{ course.credits }}</td>
              <td class="text-center">{{ course.enrollments?.length || 0 }}</td>
              <td *ngIf="currentRole.includes('Admin')" class="text-center col-1">
                <span class="badge" [ngClass]="course.statuse === 'Active' ? 'bg-success' : 'bg-secondary'">
                  {{ course.statuse }}
                </span>
              </td>

              <td class="text-center pe-4">
                <!-- Admin sees actions always -->
                <ng-container *ngIf="currentRole.includes('Admin'); else teacherActions">
                  <!-- View -->
                  <button class="btn btn-sm btn-link p-0 me-2" [routerLink]="['/courses', course.id]" title="View">
                    <i class="fa-solid fa-eye text-info"></i>
                  </button>

                  <!-- Edit -->
                  <button class="btn btn-sm btn-link p-0 me-2" [routerLink]="['/courses', course.id, 'edit']"
                    title="Edit">
                    <i class="fa-solid fa-gear text-muted"></i>
                  </button>

                  <!-- Delete / Restore -->
                  <button class="btn btn-sm btn-link p-0" (click)="delete(course)" [disabled]="isDeleting"
                    title="{{ course.statuse == 'Active' ? 'Delete' : 'Restore' }}">
                    <i *ngIf="course.statuse == 'Active'" class="fa-solid fa-trash-can text-danger"></i>

                    <i *ngIf="course.statuse == 'InActive'" class="fa-solid fa-trash-arrow-up text-danger"></i>
                  </button>
                </ng-container>


                <!-- Teacher sees actions only if this is their course -->
                <ng-template #teacherActions>
                  <button class="btn btn-sm btn-outline-secondary me-2" [routerLink]="['/courses', course.id]">
                    <i class="fa-solid fa-eye me-1"></i>
                    view
                  </button>
                  <ng-container *ngIf="course.teacherId === currentUserId; else noTeacherPerm">
                    <button class="btn btn-sm btn-outline-secondary me-2"
                      [routerLink]="['/courses', course.id, 'edit']">
                      <i class="fa-solid fa-gear me-1"></i>
                      Edit
                    </button>

                  </ng-container>

                  <ng-template #noTeacherPerm>
                    <span class="text-muted small">â€”</span>
                  </ng-template>
                </ng-template>
              </td>

              <td *ngIf="currentRole.includes('Admin')" class="text-end pe-3">
                <mat-checkbox [checked]="isCourseSelected(course.id)"
                  (change)="toggleCourseOne(course.id, $event.checked)">
                </mat-checkbox>
              </td>

            </tr>
          </tbody>
        </table>
        <div *ngIf="courses.length === 0" class="alert alert-info text-center">No courses found.</div>
        <div class="d-flex justify-content-center p-3 bg-white border-top" *ngIf="totalCount > 0">
          <mat-paginator [length]="totalCount" [pageSize]="pageSize" [pageIndex]="page - 1"
            [pageSizeOptions]="[5, 10, 20, 50]" (page)="onPageChange($event)">
          </mat-paginator>
        </div>
      </div>
    </div>