<!-- Header -->
<div class="  flex-md-row justify-content-between align-items-start align-items-md-center mb-4 gap-2">
  <div>
    <h2 class="fw-semibold m-0">Courses</h2>
    <div class="text-muted small">Browse and manage courses based on your role.</div>
  </div>
  <div class="row g-2 mb-4">
    <div class="col-12 col-md-6 col-lg-5">
      <mat-form-field appearance="outline" class="w-100">
        <mat-label>Search courses or teacher</mat-label>
        <input matInput [value]="search" (input)="onSearchChange(($any($event.target)).value)"
          placeholder="e.g. Math, Ahmed" />
        <button *ngIf="search" matSuffix mat-icon-button aria-label="Clear" (click)="onSearchChange('')">
          <mat-icon>close</mat-icon>
        </button>
      </mat-form-field>
    </div>
  </div>


  <!-- Add Course only for Admin/Teacher -->
  <button *ngIf="currentRole === 'Admin' || currentRole === 'Teacher'" class="btn btn-primary px-3"
    routerLink="/courses/create">
    <i class="fa-solid fa-folder-plus me-2"></i>
    Add Course
  </button>
</div>

<!-- Loading / Errors -->
<div *ngIf="isLoading" class="alert alert-info">Loading...</div>
<div *ngIf="error" class="alert alert-danger">{{ error }}</div>
<div *ngIf="deleteError" class="alert alert-danger">{{ deleteError }}</div>

<!-- ============================= -->
<!-- STUDENT VIEW (Cards like image) -->
<!-- ============================= -->
<div *ngIf="!isLoading && currentRole === 'Student'">
  <div class="row g-4">
    <div class="col-12 col-sm-6 col-lg-4" *ngFor="let course of courses">
      <div class="card border-0 shadow-sm h-100 rounded-4 overflow-hidden course-card">
        <!-- image area -->
        <div class="course-thumb d-flex align-items-center justify-content-center text-center text-white fw-semibold"
          [ngStyle]="{
    'background-image': 'url(' + getCourseBackground(course.id) + ')'
  }">
          <span class="course-title-overlay">
            {{ course.name }}
          </span>
        </div>


        <div class="card-body p-3">
          <div class="fw-semibold text-dark mb-1 text-truncate">
            {{ course.name }}
          </div>

          <div class="text-muted small mb-3 course-desc">
            {{
            course.description?.length > 90
            ? (course.description | slice:0:90) + '...'
            : course.description
            }}
          </div>

          <div class="d-flex align-items-center justify-content-between">
            <div class="text-muted small">
              <span class="me-2"><i class="fa-regular fa-star me-1"></i>{{ course.credits }} credits</span>
              <span><i class="fa-solid fa-users me-1"></i>{{ course.enrollments?.length || 0 }}</span>
            </div>

            <!-- View only -->
            <a class="course-link text-decoration-none fw-semibold" [routerLink]="['/courses', course.id]">
              View
              <i class="fa-solid fa-arrow-down ms-2 small"></i>
            </a>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ============================= -->
<!-- ADMIN/TEACHER VIEW (Table) -->
<!-- ============================= -->
<div *ngIf="!isLoading && (currentRole === 'Admin' || currentRole === 'Teacher')"
  class="shadow-sm rounded-4 overflow-hidden">
  <div class="table-responsive">
    <table class="table table-hover align-middle mb-0">
      <thead class="border-bottom bg-white">
        <tr class="text-muted small">
          <th class="ps-4 col-2">Name</th>
          <th class="col-4">Description</th>
          <th class="col-1">Credits</th>
          <th class="col-1">No. Students</th>
          <th class="col-3 text-end pe-4">Actions</th>
        </tr>
      </thead>

      <tbody>
        <tr *ngFor="let course of courses">
          <td class="col-2 ps-4 fw-medium">
            {{
            course.name?.length > 20
            ? (course.name | slice:0:20) + '...'
            : course.name
            }}
          </td>

          <td class="col-4 text-muted">
            {{
            course.description?.length > 80
            ? (course.description | slice:0:80) +_attach? ??? :''
            : course.description
            }}
          </td>

          <td>{{ course.credits }}</td>
          <td>{{ course.enrollments?.length || 0 }}</td>

          <td class="text-end pe-4">
            <!-- Admin sees actions always -->
            <ng-container *ngIf="currentRole === 'Admin'; else teacherActions">
              <button class="btn btn-sm btn-outline-secondary me-2" [routerLink]="['/courses', course.id, 'edit']">
                <i class="fa-solid fa-gear me-1"></i>
                Edit
              </button>

              <button class="btn btn-sm btn-outline-danger" (click)="delete(course)" [disabled]="isDeleting">
                <i class="fa-solid fa-trash-can me-1"></i>
                Delete
              </button>
            </ng-container>

            <!-- Teacher sees actions only if this is their course -->
            <ng-template #teacherActions>
              <ng-container *ngIf="course.teacherId === currentUserId; else noTeacherPerm">
                <button class="btn btn-sm btn-outline-secondary me-2" [routerLink]="['/courses', course.id, 'edit']">
                  <i class="fa-solid fa-gear me-1"></i>
                  Edit
                </button>

                <button class="btn btn-sm btn-outline-danger" (click)="delete(course)" [disabled]="isDeleting">
                  <i class="fa-solid fa-trash-can me-1"></i>
                  Delete
                </button>
              </ng-container>

              <ng-template #noTeacherPerm>
                <span class="text-muted small">â€”</span>
              </ng-template>
            </ng-template>
          </td>
        </tr>
      </tbody>
    </table>
  </div>
</div>