<div class="course-page">
  <div class="container-fluid py-3 py-md-4">

    <!-- Header -->
    <div class="d-flex align-items-center justify-content-between mb-3">
      <div>
        <div class="tiny text-uppercase text-muted">Student manage</div>
        <div class="fw-semibold text-dark">Edit student and manage courses</div>
      </div>
      <a routerLink="/students" class="btn btn-light border rounded-pill btn-sm px-3">‚Üê Back</a>
    </div>

    <!-- Loading / Error -->
    <div *ngIf="isLoading" class="cardx p-4">
      <div class="skeleton-line w-25 mb-3"></div>
      <div class="skeleton-line w-75 mb-2"></div>
      <div class="skeleton-line w-50"></div>
    </div>

    <div *ngIf="serverError" class="alert alert-danger rounded-4 shadow-sm">
      {{ serverError }}
    </div>

    <ng-container *ngIf="!isLoading && student as s">

      <!-- HERO -->
      <div class="cardx p-3 p-md-4 mb-4">
        <div class="row g-3 g-md-4 align-items-stretch">

          <div class="col-12 col-lg-6">
            <div class="hero-box h-100">
              <div class="d-flex align-items-center gap-3">
                <div class="avatar-xl">
                  {{ (s.fullName?.[0] || '?') | uppercase }}
                </div>
                <div class="min-w-0">
                  <div class="tiny text-uppercase text-muted">Student</div>
                  <h2 class="h4 fw-bold mb-1 text-dark text-truncate">{{ s.fullName }}</h2>
                  <div class="text-muted text-truncate">{{ s.email }}</div>
                </div>
              </div>

              <div class="d-flex flex-wrap gap-2 mt-3">
                <span class="pill">üìö {{ s.enrollments?.length || 0 }} courses</span>
                <span class="pill">üìÖ {{ s.createdAt | date:'mediumDate' }}</span>
              </div>
            </div>
          </div>

          <div class="col-12 col-lg-6 d-flex flex-column">
            <div class="tiny text-uppercase text-muted mb-2">Actions</div>

            <div class="d-flex flex-wrap gap-2">
              <button class="btn btn-primary-neo px-4" (click)="viewMode = true">
                Manage Courses
              </button>
              <button class="btn btn-light border rounded-3 px-4" (click)="viewMode = false">
                Edit Student
              </button>
            </div>

            <div class="mt-auto pt-3">
              <div class="pill pill-soft">
                StudentId: {{ s.id }}
              </div>
            </div>
          </div>

        </div>
      </div>

      <!-- MANAGE COURSES MODE -->
      <div class="row g-4" *ngIf="viewMode">

        <div class="col-12 col-lg-8">

          <!-- Tabs -->
          <div class="cardx p-3 p-md-4 mb-4">
            <div class="d-flex flex-wrap gap-2">
              <button class="chip" [class.active]="manageMode" (click)="manageMode = true">
                Enrolled Courses
              </button>
              <button class="chip" [class.active]="!manageMode" (click)="newEnrollmentMode()">
                Enroll in New Course
              </button>
            </div>
          </div>

          <!-- ENROLLED COURSES LIST -->
          <div class="cardx p-3 p-md-4" *ngIf="manageMode">
            <div class="d-flex align-items-center justify-content-between mb-3">
              <div class="fw-semibold text-uppercase text-muted tiny">Enrollments</div>
              <span class="pill pill-soft">{{ s.enrollments?.length || 0 }} total</span>
            </div>

            <div *ngIf="!s.enrollments?.length" class="empty-box">
              <div class="fw-semibold mb-1">No courses enrolled yet</div>
              <div class="text-muted small">Enroll the student from ‚ÄúEnroll in New Course‚Äù.</div>
            </div>

            <div class="enroll-list" *ngIf="s.enrollments?.length">
              <div class="enroll-row" *ngFor="let e of s.enrollments; trackBy: trackById">
                <div class="d-flex align-items-center gap-3">
                  <div class="avatar-sm">{{ (e.courseName?.[0] || '?') | uppercase }}</div>
                  <div class="min-w-0">
                    <div class="fw-semibold text-dark text-truncate">{{ e.courseName }}</div>
                    <div class="text-muted small">
                      Enrolled: {{ e.enrollmentDate | date:'mediumDate' }}
                    </div>
                  </div>
                </div>

                <div class="d-flex align-items-center gap-2">
                  <!-- Update grade inline -->
                  <select class="form-select form-select-sm grade-select" [value]="e.grade || ''"
                    (change)="updateEnrollmentGrade(e.id, ($any($event.target)).value)"
                    [disabled]="isGradeUpdatingId === e.id || isUnrolling">
                    <option value="">N/A</option>
                    <option *ngFor="let g of grades" [value]="g">{{ g }}</option>
                  </select>

                  <!-- Unroll -->
                  <button type="button" class="btn btn-outline-danger btn-sm rounded-3" (click)="unRoll(e.id)"
                    [disabled]="isUnrolling">
                    Unroll
                  </button>
                </div>
              </div>
            </div>

            <div *ngIf="enrollError" class="alert alert-danger mt-3 rounded-4">
              {{ enrollError }}
            </div>
          </div>

          <!-- ENROLL IN NEW COURSE -->
          <div class="cardx p-3 p-md-4" *ngIf="!manageMode">
            <div class="d-flex align-items-center justify-content-between mb-3">
              <div class="fw-semibold text-uppercase text-muted tiny">All courses</div>
              <span class="pill pill-soft">Pick one to enroll</span>
            </div>

            <!-- Search + grade -->
            <div class="row g-2 align-items-center mb-3">
              <div class="col-12 col-md-8">
                <input class="form-control" [ngModel]="search" (ngModelChange)="onSearchChange($event)"
                  name="courseSearch" placeholder="Search by course name or description..." />
              </div>

              <div class="col-12 col-md-4">
                <select class="form-select" [(ngModel)]="selectedGrade" name="selectedGrade">
                  <option value="">Grade (optional)</option>
                  <option *ngFor="let g of grades" [value]="g">{{ g }}</option>
                </select>
              </div>
            </div>

            <div *ngIf="isCoursesLoading" class="alert alert-info rounded-4">
              Loading courses...
            </div>

            <div *ngIf="!isCoursesLoading && courses.length === 0" class="empty-box">
              <div class="fw-semibold mb-1">No courses found</div>
              <div class="text-muted small">Try a different search term.</div>
            </div>

            <div class="course-grid" *ngIf="!isCoursesLoading && courses.length">
              <button type="button" class="course-card" *ngFor="let c of courses; trackBy: trackById"
                (click)="selectCourse(c.id)" [class.selected]="selectedCourseId === c.id"
                [disabled]="!isCourseAvailable(c.id)">
                <div class="d-flex align-items-center justify-content-between gap-2">
                  <div class="min-w-0 text-start">
                    <div class="fw-semibold text-dark text-truncate">{{ c.name }}</div>
                    <div class="text-muted small text-truncate">{{ c.description.length > 20 ? c.description.slice(0,
                      20) + '...' : c.description }}</div>
                  </div>
                  <span class="pill">{{ c.credits }} cr</span>
                </div>

                <div class="tiny mt-2 text-start">
                  <span *ngIf="isCourseAvailable(c.id); else already">
                    <span class="text-muted">Available</span>
                  </span>
                  <ng-template #already>
                    <span class="text-danger">Already enrolled</span>
                  </ng-template>
                </div>
              </button>
            </div>
            <div class="d-flex justify-content-center mt-4" *ngIf="totalCount > 0">
              <mat-paginator [length]="totalCount" [pageSize]="pageSize" [pageIndex]="page - 1"
                [pageSizeOptions]="[6, 9, 12, 18]" (page)="onPageChange($event)">
              </mat-paginator>
            </div>
            <div class="mt-3 d-flex gap-2">
              <button class="btn btn-primary-neo px-4" [disabled]="!selectedCourseId || isEnrolling"
                (click)="enroll(selectedCourseId!, selectedGrade)">
                Enroll Selected
              </button>

              <button class="btn btn-light border rounded-3 px-4" type="button" (click)="manageMode = true">
                Cancel
              </button>
            </div>

            <div *ngIf="enrollError" class="alert alert-danger mt-3 rounded-4">
              {{ enrollError }}
            </div>

          </div>

        </div>

        <!-- Right side quick info -->
        <div class="col-12 col-lg-4">
          <div class="cardx p-3 p-md-4">
            <div class="fw-semibold text-uppercase text-muted tiny mb-3">Student status</div>
            <div class="d-flex flex-column gap-2">
              <div class="pill">StudentId: {{ s.id }}</div>
              <div class="pill">Courses: {{ s.enrollments?.length || 0 }}</div>
              <div class="pill">Created: {{ s.createdAt | date:'mediumDate' }}</div>
            </div>
          </div>
        </div>

      </div>

      <!-- EDIT STUDENT FORM -->
      <div class="row g-4" *ngIf="!viewMode">
        <div class="col-12 col-lg-8">
          <form [formGroup]="form" (ngSubmit)="submit()" class="cardx p-3 p-md-4">
            <div class="d-flex align-items-center justify-content-between mb-3">
              <div class="fw-semibold text-uppercase text-muted tiny">Edit student</div>
              <button class="btn btn-light border rounded-3" type="button" (click)="viewMode = true">
                Back to manage
              </button>
            </div>

            <div class="mb-3">
              <label class="form-label">Full Name</label>
              <input class="form-control" formControlName="fullName" />
              <div class="text-danger small mt-1"
                *ngIf="form.controls.fullName.touched && form.controls.fullName.invalid">
                <span *ngIf="form.controls.fullName.errors?.['required']">Full name is required.</span>
                <span *ngIf="form.controls.fullName.errors?.['minlength']">Minimum 3 characters.</span>
              </div>
            </div>

            <div class="mb-3">
              <label class="form-label">Email</label>
              <input type="email" class="form-control" formControlName="email" />
              <div class="text-danger small mt-1" *ngIf="form.controls.email.touched && form.controls.email.invalid">
                <span *ngIf="form.controls.email.errors?.['required']">Email is required.</span>
                <span *ngIf="form.controls.email.errors?.['email']">Enter a valid email.</span>
                <span *ngIf="form.controls.email.errors?.['maxlength']">Max 200 characters.</span>
              </div>
            </div>

            <div class="mb-3">
              <label class="form-label">Date Of Birth</label>
              <input type="date" class="form-control" formControlName="dateOfBirth" [max]="today" />
              <div class="text-danger small mt-1"
                *ngIf="form.controls.dateOfBirth.touched && form.controls.dateOfBirth.invalid">
                <span *ngIf="form.controls.dateOfBirth.errors?.['required']">Date of birth is required.</span>
                <span *ngIf="form.controls.dateOfBirth.errors?.['futureDate']">Cannot be in the future.</span>
                <span *ngIf="form.controls.dateOfBirth.errors?.['before1990']">Cannot be before 1990.</span>
              </div>
            </div>

            <div class="d-flex gap-2 mt-4">
              <button class="btn btn-primary-neo px-4" type="submit" [disabled]="isUpdating">
                Save changes
              </button>
              <button class="btn btn-light border rounded-3 px-4" type="button" (click)="viewMode = true"
                [disabled]="isUpdating">
                Cancel
              </button>
            </div>

            <div *ngIf="serverError" class="alert alert-danger rounded-4 mt-3">
              {{ serverError }}
            </div>
          </form>
        </div>
      </div>

    </ng-container>

  </div>
</div>